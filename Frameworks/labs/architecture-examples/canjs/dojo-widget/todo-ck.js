require({packages:[{name:"can/dojo",location:"http://canjs.us/release/latest/",main:"can.dojo"}]},["can/dojo","dojo/dom","dojo/dom-construct","dojo/dom-attr","dojo/dom-geometry","dojo/NodeList-manipulate","dijit/CalendarLite","dijit/place","dijit/focus","dojo/domReady!"],function(e,t,n,r){var i=function(e,t){e=new Date(e.getFullYear(),e.getMonth(),e.getDate());t=new Date(t.getFullYear(),t.getMonth(),t.getDate());return(e-t)/864e5};Todo=e.Model({localStore:function(t){var n="todos-canjs-dojo-widget",r=dojo.fromJson(window.localStorage[n]||(window.localStorage[n]="[]")),i=t.call(this,r);if(i!==!1){e.each(r,function(e){delete e.editing});window.localStorage[n]=dojo.toJson(r)}},findAll:function(t){var n=new dojo.Deferred;this.localStore(function(t){var r=[],i=this;e.each(t,function(e){r.push(new i(e))});n.resolve({data:r})});return n},destroy:function(e){var t=new dojo.Deferred;this.localStore(function(n){for(var r=0;r<n.length;r++)if(n[r].id===e){n.splice(r,1);break}t.resolve({})});return t},create:function(e){var t=new dojo.Deferred;this.localStore(function(t){e.id=e.id||parseInt(1e5*Math.random());t.push(e)});t.resolve({id:e.id});return t},update:function(t,n){var r=new dojo.Deferred;this.localStore(function(r){for(var i=0;i<r.length;i++)if(r[i].id===t){var s=r[i];break}e.extend(s,n)});r.resolve({});return r}},{prettyDate:function(e){var e=this.attr("dueDate");if(!e)return"";var t=new Date(e),n=i(new Date,t);return n===-1?"Tomorrow":n===0?"Today":n===1?"Yesterday":t.getMonth()+1+"/"+t.getDate()+"/"+t.getFullYear()},isLate:function(e){var e=this.attr("dueDate");return e?i(new Date,new Date(e))>0:!1}});Todo.List=e.Model.List({completed:function(){this.attr("length");var e=0;this.each(function(t){e+=t.attr("complete")?1:0});return e},remaining:function(){return this.attr("length")-this.completed()},allComplete:function(){return this.attr("length")===this.completed()}});Todos=e.Control({init:function(){this.element.append(e.view("todo",{todos:this.options.todos}));dijit.focus(dojo.byId("new-todo"));var t=this.options.calendar;dojo.query(document).on("click",function(e){!dojo.hasClass(e.target,"due-date")&&!dojo.query(e.target).closest("#calendar").length&&dojo.query(t.domNode).style("visibility","hidden")})},"#new-todo keyup":function(e,t){t.keyCode==13&&(new Todo({text:e.val(),complete:!1})).save(function(){e.val("")})},"{Todo} created":function(e,t,n){this.options.todos.push(n)},".todo dblclick":function(t){e.data(t,"todo").attr("editing",!0).save(function(){dijit.focus(t.children(".edit")[0].focus())})},updateTodo:function(t){e.data(t.closest(".todo"),"todo").attr({editing:!1,text:t.val()}).save()},".todo .edit keyup":function(e,t){t.keyCode==13&&this.updateTodo(e)},".todo .edit focusout":function(e,t){this.updateTodo(e)},".todo .toggle click":function(t,n){e.data(t.closest(".todo"),"todo").attr("complete",t.attr("checked")[0]).save()},".todo .destroy click":function(t){e.data(t.closest(".todo"),"todo").destroy()},"#toggle-all click":function(t,n){var r=t.attr("checked")[0];e.each(this.options.todos,function(e){e.attr("complete",r).save()})},"#clear-completed click":function(){for(var e=this.options.todos.length-1,t;e>-1&&(t=this.options.todos[e]);e--)t.attr("complete")&&t.destroy()},".todo .due-date click":function(t,n){n.preventDefault();var r=e.data(t.closest(".todo"),"todo"),i=this.options.calendar;dijit.place.at(i.domNode,{x:510,y:dojo.position(t[0]).y},["TL"]);i.set("value",r.dueDate||"");this._todo=r;dojo.query(i.domNode).style("visibility","visible")},".todo .clear-date click":function(t,n){e.data(t.closest(".todo"),"todo").attr("dueDate",null).save()},"{calendar} change":function(e,t){if(this._todo){dojo.query(this.options.calendar.domNode).style("visibility","hidden");this._todo.attr("dueDate",t||null).save();delete this._todo}}});Todo.findAll({},function(e){new Todos("#todoapp",{todos:e,calendar:new dijit.CalendarLite({},"calendar")})})});