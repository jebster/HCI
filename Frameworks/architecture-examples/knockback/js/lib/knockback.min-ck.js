// Generated by CoffeeScript 1.3.1
/*
 knockback.js 0.15.1
 (c) 2011 Kevin Malakoff.
 Knockback.js is freely distributable under the MIT license.
 See the following for full license details:
 https://github.com/kmalakoff/knockback/blob/master/LICENSE
 Dependencies: Knockout.js, Backbone.js, and Underscore.js.
 Optional dependency: Backbone.ModelRef.js.
*/var Backbone,Knockback,kb,ko,_;typeof exports!="undefined"?Knockback=kb=exports:this.Knockback=this.kb={};Knockback.VERSION="0.15.1";_=!this._&&typeof require!="undefined"?require("underscore"):this._;Backbone=!this.Backbone&&typeof require!="undefined"?require("backbone"):this.Backbone;ko=!this.ko&&typeof require!="undefined"?require("knockout"):this.ko;Knockback.locale_manager;Knockback.stats={collection_observables:0,view_models:0};Knockback.stats_on=!1;Knockback.utils={};Knockback.utils.legacyWarning=function(e,t,n){var r;kb._legacy_warnings||(kb._legacy_warnings={});(r=kb._legacy_warnings)[e]||(r[e]=0);kb._legacy_warnings[e]++;return console.warn("Legacy warning! '"+e+"' has been deprecated (will be removed in Knockback "+t+"). "+n+".")};Knockback.utils.wrappedObservable=function(e,t){if(arguments.length===1){if(!(e&&e.__kb&&e.__kb.observable))throw new Error("Knockback: instance is not wrapping an observable");return e.__kb.observable}if(!e)throw new Error("Knockback: no instance for wrapping a observable");e.__kb||(e.__kb={});e.__kb.observable&&e.__kb.observable.__kb&&(e.__kb.observable.__kb.instance=null);e.__kb.observable=t;if(t){t.__kb||(t.__kb={});t.__kb.instance=e}return t};Knockback.wrappedObservable=function(e){kb.utils.legacyWarning("kb.wrappedObservable","0.16.0","Please use kb.utils.wrappedObservable instead");return kb.utils.wrappedObservable(e)};Knockback.utils.observableInstanceOf=function(e,t){return e?!e.__kb||!e.__kb.instance?!1:e.__kb.instance instanceof t:!1};Knockback.utils.wrappedModel=function(e,t){if(arguments.length===1)return e&&e.__kb&&e.__kb.hasOwnProperty("model")?e.__kb.model:e;if(!e)throw new Error("Knockback: no view_model for wrapping a model");e.__kb||(e.__kb={});e.__kb.model=t;return t};Knockback.viewModelGetModel=Knockback.vmModel=function(e){kb.utils.legacyWarning("kb.vmModel","0.16.0","Please use kb.utils.wrappedModel instead");return kb.utils.wrappedModel(e)};Knockback.utils.setToDefault=function(e){var t,n,r;if(!e)return;if(ko.isObservable(e))return typeof e.setToDefault=="function"?e.setToDefault():void 0;if(_.isObject(e)){r=[];for(t in e){n=e[t];r.push(n&&t!=="__kb"?kb.utils.setToDefault(n):void 0)}return r}};Knockback.vmSetToDefault=function(e){kb.utils.legacyWarning("kb.vmSetToDefault","0.16.0","Please use kb.utils.release instead");return kb.utils.setToDefault(e)};Knockback.utils.release=function(e){var t,n;if(!e)return!1;if(ko.isObservable(e)||e instanceof kb.Observables||typeof e.release=="function"||typeof e.destroy=="function"){e.release?e.release():e.destroy?e.destroy():e.dispose&&e.dispose();return!0}if(_.isObject(e)&&typeof e!="function"){for(t in e){n=e[t];if(!n||t==="__kb")continue;kb.utils.release(n)&&(e[t]=null)}return!0}return!1};Knockback.vmRelease=function(e){kb.utils.legacyWarning("kb.vmRelease","0.16.0","Please use kb.utils.release instead");return kb.utils.release(e)};Knockback.vmReleaseObservable=function(e){kb.utils.legacyWarning("kb.vmReleaseObservable","0.16.0","Please use kb.utils.release instead");return kb.utils.release(e)};kb.utils.optionsCreateClear=function(e){delete e.create;delete e.children;delete e.view_model;return delete e.view_model_create};kb.utils.optionsCreateOverride=function(e,t){kb.utils.optionsCreateClear(e);return _.extend(e,t)};Knockback.RefCountable=function(){function e(){this.__kb||(this.__kb={});this.__kb.ref_count=1}e.name="RefCountable";e.extend=Backbone.Model.extend;e.prototype.__destroy=function(){};e.prototype.retain=function(){if(this.__kb.ref_count<=0)throw new Error("RefCountable: ref_count is corrupt: "+this.__kb.ref_count);this.__kb.ref_count++;return this};e.prototype.release=function(){if(this.__kb.ref_count<=0)throw new Error("RefCountable: ref_count is corrupt: "+this.__kb.ref_count);this.__kb.ref_count--;this.__kb.ref_count||this.__destroy();return this};e.prototype.refCount=function(){return this.__kb.ref_count};return e}();Knockback.Store=function(){function e(){this.keys=[];this.values=[]}e.name="Store";e.prototype.destroy=function(){var e,t,n,r;this.keys=null;n=this.values;for(e in n){t=n[e];if(!kb.utils.observableInstanceOf(t,kb.CollectionObservable))continue;this.values[e]=null;while(t.refCount()>0)t.release()}r=this.values;for(e in r){t=r[e];if(!t)continue;this.values[e]=null;if(t instanceof kb.RefCountable)while(t.refCount()>0)t.release();else kb.utils.release(t)}return this.values=null};e.prototype.registerValue=function(e,t){var n;t instanceof kb.RefCountable&&t.retain();n=_.indexOf(this.keys,e);if(n>=0)this.values[n]=t;else{this.keys.push(e);this.values.push(t)}return t};e.prototype.resolveValue=function(e,t,n){var r,i;r=_.indexOf(this.keys,e);if(r>=0){if(this.values[r]){if(!(this.values[r]instanceof kb.RefCountable&&this.values[r].refCount()<=0))return this.values[r]instanceof kb.RefCountable?this.values[r].retain():this.values[r];this.values[r]=null}}else{r=this.keys.length;this.keys.push(e);this.values.push(void 0)}i=t.apply(null,Array.prototype.slice.call(arguments,2));if(this.keys[r]!==e)this.registerValue(e,i);else if(!this.values[r]){i instanceof kb.RefCountable&&i.retain();this.values[r]=i}return i};e.prototype.releaseValue=function(e){var t;if(e instanceof kb.RefCountable){e.release();if(e.refCount()>0)return;t=_.indexOf(this.values,e);if(t>=0)return this.values[t]=0;return}return};e.prototype.addResolverToOptions=function(e,t){return _.extend(e,{store:this,store_key:t})};e.resolveFromOptions=function(e,t){if(!e.store||!e.store_key)return;return e.store.registerValue(e.store_key,t)};return e}();var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);r.prototype=t.prototype;e.prototype=new r;e.__super__=t.prototype;return e};Knockback.CollectionObservable=function(e){function t(e,n){var r,i,s=this;n==null&&(n={});if(!e)throw new Error("CollectionObservable: collection is missing");t.__super__.constructor.apply(this,arguments);Knockback.stats_on&&kb.stats.collection_observables++;if(ko.isObservable(n)&&n.hasOwnProperty("indexOf")){kb.utils.legacyWarning("kb.collectionObservable with an external ko.observableArray","0.16.0","Please use the kb.collectionObservable directly instead of passing a ko.observableArray");i=kb.utils.wrappedObservable(this,n);n=arguments[2]||{};r=!0}else i=kb.utils.wrappedObservable(this,ko.observableArray([]));n.store_skip_resolve||kb.Store.resolveFromOptions(n,kb.utils.wrappedObservable(this));if(n.store)this.__kb.store=n.store;else{this.__kb.store=new kb.Store;this.__kb.store_is_owned=!0}if(n.hasOwnProperty("view_model")){if(!n.view_model)throw new Error("Knockback.CollectionObservable: options.view_model is empty");this.view_model_create_fn=n.view_model;this.view_model_create_with_new=!0}else if(n.hasOwnProperty("view_model_constructor")){if(!n.view_model_constructor)throw new Error("Knockback.CollectionObservable: options.view_model_constructor is empty");kb.utils.legacyWarning("kb.collectionObservable option view_model_constructor","0.16.0","Please use view_model option instead");this.view_model_create_fn=n.view_model_constructor;this.view_model_create_with_new=!0}else if(n.hasOwnProperty("view_model_create")){if(!n.view_model_create)throw new Error("Knockback.CollectionObservable: options.view_model_create is empty");this.view_model_create_fn=n.view_model_create}else if(n.hasOwnProperty("create")){if(!n.create)throw new Error("Knockback.CollectionObservable: options.create is empty");this.view_model_create_fn=n.create}this.sort_attribute=n.sort_attribute;this.sorted_index=n.sorted_index;this.__kb._onCollectionReset=_.bind(this._onCollectionReset,this);this.__kb._onCollectionResort=_.bind(this._onCollectionResort,this);this.__kb._onModelAdd=_.bind(this._onModelAdd,this);this.__kb._onModelRemove=_.bind(this._onModelRemove,this);this.__kb._onModelChange=_.bind(this._onModelChange,this);r&&e&&e.bind("change",function(){return kb.utils.wrappedObservable(s).valueHasMutated()});i.retain=_.bind(this.retain,this);i.refCount=_.bind(this.refCount,this);i.release=_.bind(this.release,this);i.collection=_.bind(this.collection,this);i.viewModelByModel=_.bind(this.viewModelByModel,this);i.sortedIndex=_.bind(this.sortedIndex,this);i.sortAttribute=_.bind(this.sortAttribute,this);i.hasViewModels=_.bind(this.hasViewModels,this);i.bind=_.bind(this.bind,this);i.unbind=_.bind(this.unbind,this);i.trigger=_.bind(this.trigger,this);this.collection(e,{silent:!0,defer:n.defer});return i}__extends(t,e);t.name="CollectionObservable";t.prototype.__destroy=function(){this.collection(null);if(this.hasViewModels()&&this.__kb.store_is_owned){this.__kb.store.destroy();this.__kb.store=null}this.view_model_create_fn=null;this.__kb.collection=null;kb.utils.wrappedObservable(this,null);t.__super__.__destroy.apply(this,arguments);if(Knockback.stats_on)return kb.stats.collection_observables--};t.prototype.retain=function(){t.__super__.retain.apply(this,arguments);return kb.utils.wrappedObservable(this)};t.prototype.release=function(){var e;e=kb.utils.wrappedObservable(this);t.__super__.release.apply(this,arguments);return e};t.prototype.collection=function(e,t){var n,r,i;n=kb.utils.wrappedObservable(this);if(arguments.length===0){n();return this.__kb.collection}if(e===this.__kb.collection)return;if(this.__kb.collection){this._clear();this._collectionUnbind(this.__kb.collection);typeof (r=this.__kb.collection).release=="function"&&r.release();this.__kb.collection=null}this.__kb.collection=e;if(this.__kb.collection){typeof (i=this.__kb.collection).retain=="function"&&i.retain();this._collectionBind(this.__kb.collection);return this.sortedIndex(this.sorted_index,this.sort_attribute,t)}};t.prototype.sortedIndex=function(e,t,n){var r,i=this;n==null&&(n={});if(e){this.sorted_index=e;this.sort_attribute=t}else if(t){this.sort_attribute=t;this.sorted_index=this._sortAttributeFn(t)}else{this.sort_attribute=null;this.sorted_index=null}r=function(){var e;e=kb.utils.wrappedObservable(i);if(i.__kb.collection.models.length===0&&e().length===0)return;i._collectionResync(!0);if(!n.silent)return i.trigger("resort",e())};n.defer?_.defer(r):r();return this};t.prototype.sortAttribute=function(e,t,n){return this.sortedIndex(t,e,n)};t.prototype.viewModelByModel=function(e){var t,n;if(!this.hasViewModels())return null;n=kb.utils.wrappedObservable(this);t=e.hasOwnProperty(e.idAttribute)?e.idAttribute:"cid";return _.find(n(),function(n){return n.__kb.model[t]===e[t]})};t.prototype.hasViewModels=function(){return!!this.view_model_create_fn};t.prototype._collectionBind=function(e){var t,n,r,i,s,o,u;if(!e)return;e.bind("reset",this.__kb._onCollectionReset);this.sorted_index||e.bind("resort",this.__kb._onCollectionResort);o=["new","add"];for(n=0,i=o.length;n<i;n++){t=o[n];e.bind(t,this.__kb._onModelAdd)}u=["remove","destroy"];for(r=0,s=u.length;r<s;r++){t=u[r];e.bind(t,this.__kb._onModelRemove)}return e.bind("change",this.__kb._onModelChange)};t.prototype._collectionUnbind=function(e){var t,n,r,i,s,o,u;if(!e)return;e.unbind("reset",this.__kb._onCollectionReset);this.sorted_index||e.unbind("resort",this.__kb._onCollectionResort);o=["new","add"];for(n=0,i=o.length;n<i;n++){t=o[n];e.unbind(t,this.__kb._onModelAdd)}u=["remove","destroy"];for(r=0,s=u.length;r<s;r++){t=u[r];e.unbind(t,this.__kb._onModelRemove)}return e.unbind("change",this.__kb._onModelChange)};t.prototype._onCollectionReset=function(){return this._collectionResync()};t.prototype._onCollectionResort=function(e){var t;if(this.sorted_index)throw new Error("CollectionObservable: collection sorted_index unexpected");if(_.isArray(e)){t=kb.utils.wrappedObservable(this);return this.trigger("resort",t())}return this._onModelResort(e)};t.prototype._onModelAdd=function(e){var t,n,r;r=this.hasViewModels()?this._createTarget(e):e;n=kb.utils.wrappedObservable(this);this.sorted_index?t=this.sorted_index(n(),r):t=this.__kb.collection.indexOf(e);n.splice(t,0,r);return this.trigger("add",r,n())};t.prototype._onModelRemove=function(e){var t,n;n=this.hasViewModels()?this.viewModelByModel(e):e;if(!n)return;t=kb.utils.wrappedObservable(this);t.remove(n);this.trigger("remove",n,t);if(this.hasViewModels())return this.__kb.store.releaseValue(n)};t.prototype._onModelChange=function(e){if(this.sorted_index&&(!this.sort_attribute||e.hasChanged(this.sort_attribute)))return this._onModelResort(e)};t.prototype._onModelResort=function(e){var t,n,r,i,s;n=kb.utils.wrappedObservable(this);s=this.hasViewModels()?this.viewModelByModel(e):e;r=n.indexOf(s);if(this.sorted_index){i=_.clone(n());i.splice(r,1);t=this.sorted_index(i,s)}else t=this.__kb.collection.indexOf(e);if(r===t)return;n.splice(r,1);n.splice(t,0,s);return this.trigger("resort",s,n(),t)};t.prototype._clear=function(e){var t,n,r,i,s,o;t=kb.utils.wrappedObservable(this);e||this.trigger("remove",t());r=t.removeAll();if(this.hasViewModels()){o=[];for(i=0,s=r.length;i<s;i++){n=r[i];o.push(this.__kb.store.releaseValue(n))}return o}};t.prototype._collectionResync=function(e){var t,n,r,i,s,o,u,a,f=this;this._clear(e);r=kb.utils.wrappedObservable(this);if(this.sorted_index){s=[];a=this.__kb.collection.models;for(o=0,u=a.length;o<u;o++){n=a[o];i=this._createTarget(n);t=this.sorted_index(s,i);s.splice(t,0,i)}}else s=this.hasViewModels()?_.map(this.__kb.collection.models,function(e){return f._createTarget(e)}):_.clone(this.__kb.collection.models);r(s);if(!e)return this.trigger("add",r())};t.prototype._sortAttributeFn=function(e){return this.hasViewModels()?function(t,n){return _.sortedIndex(t,n,function(t){return kb.utils.wrappedModel(t).get(e)})}:function(t,n){return _.sortedIndex(t,n,function(t){return t.get(e)})}};t.prototype._createTarget=function(e){var t,n=this;t=function(){var t,r,i;r=n.__kb.store.addResolverToOptions({},e);t=kb.utils.wrappedObservable(n);i=n.view_model_create_with_new?new n.view_model_create_fn(e,r,t):n.view_model_create_fn(e,r,t);kb.utils.wrappedModel(i,e);return i};return this.hasViewModels()?this.__kb.store.resolveValue(e,t):e};return t}(kb.RefCountable);__extends(Knockback.CollectionObservable.prototype,Backbone.Events);Knockback.collectionObservable=function(e,t,n){return new Knockback.CollectionObservable(e,t,n)};Knockback.sortedIndexWrapAttr=Knockback.siwa=function(e,t){return function(n,r){return _.sortedIndex(n,r,function(n){return new t(kb.utils.wrappedModel(n).get(e))})}};if(!this.Knockback)throw new Error("Knockback: Dependency alert! knockback_core.js must be included before this file");Knockback.DefaultWrapper=function(){function e(e,t){var n,r=this;this.default_value_observable=t;this.__kb={};n=kb.utils.wrappedObservable(this,ko.dependentObservable({read:function(){var t,n;n=ko.utils.unwrapObservable(e());t=ko.utils.unwrapObservable(r.default_value_observable);return n?n:t},write:function(t){return e(t)}}));n.destroy=_.bind(this.destroy,this);n.setToDefault=_.bind(this.setToDefault,this);return n}e.name="DefaultWrapper";e.prototype.destroy=function(){kb.utils.wrappedObservable(this,null);return this.default_value=null};e.prototype.setToDefault=function(){var e;e=kb.utils.wrappedObservable(this);return e(this.default_value_observable)};return e}();Knockback.defaultWrapper=function(e,t){return new Knockback.DefaultWrapper(e,t)};Knockback.toFormattedString=function(e){var t,n,r,i,s,o;s=e.slice();n=Array.prototype.slice.call(arguments,1);for(r in n){t=n[r];o=ko.utils.unwrapObservable(t);o||(o="");i=e.indexOf("{"+r+"}");while(i>=0){s=s.replace("{"+r+"}",o);i=e.indexOf("{"+r+"}",i+1)}}return s};Knockback.parseFormattedString=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v;c=t.slice();i=0;u=0;f={};while(c.search("\\{"+i+"\\}")>=0){a=t.indexOf("{"+i+"}");while(a>=0){c=c.replace("{"+i+"}","(.*)");f[a]=i;u++;a=t.indexOf("{"+i+"}",a+1)}i++}n=i;l=new RegExp(c);o=l.exec(e);o&&o.shift();if(!o||o.length!==u)return _.map(function(){v=[];for(var e=1;1<=n?e<=n:e>=n;1<=n?e++:e--)v.push(e);return v}.apply(this),function(){return""});p=_.sortBy(_.keys(f),function(e,t){return parseInt(e,10)});r={};for(s in p){a=p[s];i=f[a];if(r.hasOwnProperty(i))continue;r[i]=s}h=[];i=0;while(i<n){h.push(o[r[i]]);i++}return h};Knockback.FormattedObservable=function(){function e(e,t){var n,r;this.__kb={};if(_.isArray(t)){e=e;r=t}else r=Array.prototype.slice.call(arguments,1);n=kb.utils.wrappedObservable(this,ko.dependentObservable({read:function(){var n,i,s;t=[ko.utils.unwrapObservable(e)];for(i=0,s=r.length;i<s;i++){n=r[i];t.push(ko.utils.unwrapObservable(n))}return kb.toFormattedString.apply(null,t)},write:function(t){var n,i,s,o;i=kb.parseFormattedString(t,ko.utils.unwrapObservable(e));s=Math.min(r.length,i.length);n=0;o=[];while(n<s){r[n](i[n]);o.push(n++)}return o}}));return n}e.name="FormattedObservable";e.prototype.destroy=function(){return kb.utils.wrappedObservable(this,null)};return e}();Knockback.formattedObservable=function(e,t){return new Knockback.FormattedObservable(e,Array.prototype.slice.call(arguments,1))};Knockback.LocalizedObservable=function(){function e(e,t,n){var r;this.value=e;this.options=t!=null?t:{};this.view_model=n!=null?n:{};if(!this.options.read&&!this.read)throw new Error("LocalizedObservable: options.read is missing");if(this.options.read&&this.read)throw new Error("LocalizedObservable: options.read and read class function exist. You need to choose one.");if(this.options.write&&this.write)throw new Error("LocalizedObservable: options.write and write class function exist. You need to choose one.");if(!kb.locale_manager)throw new Error("LocalizedObservable: Knockback.locale_manager is not defined");this.__kb={};this.__kb._onLocaleChange=_.bind(this._onLocaleChange,this);this.value&&(e=ko.utils.unwrapObservable(this.value));this.__kb.value_observable=ko.observable(e?this.read.call(this,e,null):this._getDefaultValue());if(this.write&&typeof this.write!="function")throw new Error("LocalizedObservable: options.write is not a function for read_write model attribute");r=kb.utils.wrappedObservable(this,ko.dependentObservable({read:_.bind(this._onGetValue,this),write:this.write?_.bind(this._onSetValue,this):function(){throw new Error("Knockback.LocalizedObservable: value is read only")},owner:this.view_model}));r.destroy=_.bind(this.destroy,this);r.observedValue=_.bind(this.observedValue,this);r.setToDefault=_.bind(this.setToDefault,this);r.resetToCurrent=_.bind(this.resetToCurrent,this);kb.locale_manager.bind("change",this.__kb._onLocaleChange);return r}e.name="LocalizedObservable";e.extend=Backbone.Model.extend;e.prototype.destroy=function(){kb.locale_manager.unbind("change",this.__kb._onLocaleChange);this.__kb.value_observable=null;kb.utils.wrappedObservable(this).dispose();kb.utils.wrappedObservable(this,null);this.options={};this.view_model=null;return this.__kb=null};e.prototype.setToDefault=function(){var e,t;if(!this["default"])return;t=this._getDefaultValue();e=this.__kb.value_observable();return e!==t?this._onSetValue(t):this.__kb.value_observable.valueHasMutated()};e.prototype.resetToCurrent=function(){this.__kb.value_observable(null);return this._onSetValue(this._getCurrentValue())};e.prototype.observedValue=function(e){if(arguments.length===0)return this.value;this.value=e;this._onLocaleChange();return this};e.prototype._getDefaultValue=function(){return this["default"]?typeof this["default"]=="function"?this["default"]():this["default"]:""};e.prototype._getCurrentValue=function(){var e;e=kb.utils.wrappedObservable(this);return!this.value||!e?this._getDefaultValue():this.read.call(this,ko.utils.unwrapObservable(this.value))};e.prototype._onGetValue=function(){this.value&&ko.utils.unwrapObservable(this.value);return this.__kb.value_observable()};e.prototype._onSetValue=function(e){this.write.call(this,e,ko.utils.unwrapObservable(this.value));e=this.read.call(this,ko.utils.unwrapObservable(this.value));this.__kb.value_observable(e);if(this.options.onChange)return this.options.onChange(e)};e.prototype._onLocaleChange=function(){var e;e=this.read.call(this,ko.utils.unwrapObservable(this.value));this.__kb.value_observable(e);if(this.options.onChange)return this.options.onChange(e)};return e}();Knockback.localizedObservable=function(e,t,n){return new Knockback.LocalizedObservable(e,t,n)};Knockback.Observable=function(){function e(e,t,n){var r,i=this;this.model=e;this.mapping_info=t;this.view_model=n!=null?n:{};if(!this.model)throw new Error("Observable: model is missing");if(!this.mapping_info)throw new Error("Observable: mapping_info is missing");if(_.isString(this.mapping_info)||ko.isObservable(this.mapping_info))this.mapping_info={key:this.mapping_info};if(!this.mapping_info.key)throw new Error("Observable: mapping_info.key is missing");this.__kb={};this.__kb._onModelChange=_.bind(this._onModelChange,this);this.__kb._onModelLoaded=_.bind(this._onModelLoaded,this);this.__kb._onModelUnloaded=_.bind(this._onModelUnloaded,this);if(this.mapping_info.hasOwnProperty("write")&&_.isBoolean(this.mapping_info.write)){this.mapping_info=_.clone(this.mapping_info);this.mapping_info.read_only=!this.mapping_info.write}if(Backbone.ModelRef&&this.model instanceof Backbone.ModelRef){this.model_ref=this.model;this.model_ref.retain();this.model_ref.bind("loaded",this.__kb._onModelLoaded);this.model_ref.bind("unloaded",this.__kb._onModelUnloaded);this.model=this.model_ref.getModel()}this.__kb.value_observable=ko.observable();this.mapping_info.localizer&&(this.__kb.localizer=new this.mapping_info.localizer(this._getCurrentValue()));r=kb.utils.wrappedObservable(this,ko.dependentObservable({read:_.bind(this._onGetValue,this),write:this.mapping_info.read_only?function(){throw new Error("Knockback.Observable: "+i.mapping_info.key+" is read only")}:_.bind(this._onSetValue,this),owner:this.view_model}));r.destroy=_.bind(this.destroy,this);r.setToDefault=_.bind(this.setToDefault,this);(!this.model_ref||this.model_ref.isLoaded())&&this.model.bind("change",this.__kb._onModelChange);return r}e.name="Observable";e.prototype.destroy=function(){this.__kb.value_observable=null;kb.utils.wrappedObservable(this).dispose();kb.utils.wrappedObservable(this,null);this.model&&this.__kb._onModelUnloaded(this.model);if(this.model_ref){this.model_ref.unbind("loaded",this.__kb._onModelLoaded);this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded);this.model_ref.release();this.model_ref=null}this.mapping_info=null;this.view_model=null;return this.__kb=null};e.prototype.setToDefault=function(){var e;e=this._getDefaultValue();if(this.__kb.localizer){this.__kb.localizer.observedValue(e);e=this.__kb.localizer()}return this.__kb.value_observable(e)};e.prototype._getDefaultValue=function(){return this.mapping_info.hasOwnProperty("default")?typeof this.mapping_info["default"]=="function"?this.mapping_info["default"]():this.mapping_info["default"]:""};e.prototype._getCurrentValue=function(){var e,t,n,r,i,s;if(!this.model)return this._getDefaultValue();n=ko.utils.unwrapObservable(this.mapping_info.key);t=[n];if(!_.isUndefined(this.mapping_info.args))if(_.isArray(this.mapping_info.args)){s=this.mapping_info.args;for(r=0,i=s.length;r<i;r++){e=s[r];t.push(ko.utils.unwrapObservable(e))}}else t.push(ko.utils.unwrapObservable(this.mapping_info.args));return this.mapping_info.read?this.mapping_info.read.apply(this.view_model,t):this.model.get.apply(this.model,t)};e.prototype._onGetValue=function(){var e,t,n,r,i;this.__kb.value_observable();ko.utils.unwrapObservable(this.mapping_info.key);if(!_.isUndefined(this.mapping_info.args))if(_.isArray(this.mapping_info.args)){i=this.mapping_info.args;for(n=0,r=i.length;n<r;n++){e=i[n];ko.utils.unwrapObservable(e)}}else ko.utils.unwrapObservable(this.mapping_info.args);t=this._getCurrentValue();if(this.__kb.localizer){this.__kb.localizer.observedValue(t);t=this.__kb.localizer()}return t};e.prototype._onSetValue=function(e){var t,n,r,i,s,o;if(this.__kb.localizer){this.__kb.localizer(e);e=this.__kb.localizer.observedValue()}if(this.model){r={};r[ko.utils.unwrapObservable(this.mapping_info.key)]=e;n=typeof this.mapping_info.write=="function"?[e]:[r];if(!_.isUndefined(this.mapping_info.args))if(_.isArray(this.mapping_info.args)){o=this.mapping_info.args;for(i=0,s=o.length;i<s;i++){t=o[i];n.push(ko.utils.unwrapObservable(t))}}else n.push(ko.utils.unwrapObservable(this.mapping_info.args));typeof this.mapping_info.write=="function"?this.mapping_info.write.apply(this.view_model,n):this.model.set.apply(this.model,n)}return this.__kb.localizer?this.__kb.value_observable(this.__kb.localizer()):this.__kb.value_observable(e)};e.prototype._modelBind=function(e){if(!e)return;e.bind("change",this.__kb._onModelChange);if(Backbone.RelationalModel&&e instanceof Backbone.RelationalModel){e.bind("add",this.__kb._onModelChange);e.bind("remove",this.__kb._onModelChange);return e.bind("update",this.__kb._onModelChange)}};e.prototype._modelUnbind=function(e){if(!e)return;e.unbind("change",this.__kb._onModelChange);if(Backbone.RelationalModel&&e instanceof Backbone.RelationalModel){e.unbind("add",this.__kb._onModelChange);e.unbind("remove",this.__kb._onModelChange);return e.unbind("update",this.__kb._onModelChange)}};e.prototype._onModelLoaded=function(e){this.model=e;this._modelBind(e);return this._updateValue()};e.prototype._onModelUnloaded=function(e){if(this.__kb.localizer&&this.__kb.localizer.destroy){this.__kb.localizer.destroy();this.__kb.localizer=null}this._modelUnbind(e);return this.model=null};e.prototype._onModelChange=function(){if(this.model&&this.model.hasChanged&&!this.model.hasChanged(ko.utils.unwrapObservable(this.mapping_info.key)))return;return this._updateValue()};e.prototype._updateValue=function(){var e;e=this._getCurrentValue();if(this.__kb.localizer){this.__kb.localizer.observedValue(e);e=this.__kb.localizer()}return this.__kb.value_observable(e)};return e}();Knockback.observable=function(e,t,n){return new Knockback.Observable(e,t,n)};Knockback.Observables=function(){function e(e,t,n,r){var i,s,o,u,a,f;if(!e)throw new Error("Observables: model is missing");if(!t||!_.isObject(t))throw new Error("Observables: mappings_info is missing");this.__kb||(this.__kb={});this.__kb.model=e;this.__kb.mappings_info=t;this.__kb.view_model=_.isUndefined(n)?this:n;if(!_.isUndefined(r)&&r.hasOwnProperty("write")){kb.utils.legacyWarning("Knockback.Observables option.write","0.16.0","Now default is writable so only supply read_only as required");r.read_only=!r.write;delete r.write}if(!_.isUndefined(r)){u=_.isBoolean(r)?r:r.read_only;a=this.__kb.mappings_info;for(o in a){s=a[o];i=_.isString(s);i?s=_.isUndefined(u)?{key:s}:{key:s,read_only:u}:!_.isUndefined(u)&&!s.hasOwnProperty("read_only")&&!s.hasOwnProperty("write")&&(s.read_only=u);s.hasOwnProperty("key")||(s.key=o);this[o]=this.__kb.view_model[o]=kb.observable(this.__kb.model,s,this.__kb.view_model)}}else{f=this.__kb.mappings_info;for(o in f){s=f[o];s.hasOwnProperty("write")&&kb.utils.legacyWarning("Knockback.Observables option.write","0.16.0","Now default is writable so only supply read_only as required");s.hasOwnProperty("key")||(s.key=o);this[o]=this.__kb.view_model[o]=kb.observable(this.__kb.model,s,this.__kb.view_model)}}}e.name="Observables";e.prototype.destroy=function(){var e,t,n;n=this.__kb.mappings_info;for(t in n){e=n[t];this.__kb.view_model[t]&&this.__kb.view_model[t].destroy();this.__kb.view_model[t]=null;this[t]=null}this.__kb.view_model=null;this.__kb.mappings_info=null;return this.__kb.model=null};e.prototype.setToDefault=function(){var e,t,n,r;n=this.__kb.mappings_info;r=[];for(t in n){e=n[t];r.push(this.__kb.view_model[t].setToDefault())}return r};return e}();Knockback.observables=function(e,t,n,r){return new Knockback.Observables(e,t,n,r)};Knockback.TriggeredObservable=function(){function e(e,t){var n;this.model=e;this.event_name=t;if(!this.model)throw new Error("Observable: model is missing");if(!this.event_name)throw new Error("Observable: event_name is missing");this.__kb={};this.__kb._onValueChange=_.bind(this._onValueChange,this);this.__kb._onModelLoaded=_.bind(this._onModelLoaded,this);this.__kb._onModelUnloaded=_.bind(this._onModelUnloaded,this);if(Backbone.ModelRef&&this.model instanceof Backbone.ModelRef){this.model_ref=this.model;this.model_ref.retain();this.model_ref.bind("loaded",this.__kb._onModelLoaded);this.model_ref.bind("unloaded",this.__kb._onModelUnloaded);this.model=this.model_ref.getModel()}this.__kb.value_observable=ko.observable();n=kb.utils.wrappedObservable(this,ko.dependentObservable(_.bind(this._onGetValue,this)));n.destroy=_.bind(this.destroy,this);(!this.model_ref||this.model_ref.isLoaded())&&this._onModelLoaded(this.model);return n}e.name="TriggeredObservable";e.prototype.destroy=function(){kb.utils.wrappedObservable(this).dispose();kb.utils.wrappedObservable(this,null);this.__kb.value_observable=null;this.model&&this._onModelUnloaded(this.model);if(this.model_ref){this.model_ref.unbind("loaded",this.__kb._onModelLoaded);this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded);this.model_ref.release();this.model_ref=null}this.options=null;this.view_model=null;return this.__kb=null};e.prototype._onGetValue=function(){return this.__kb.value_observable()};e.prototype._onModelLoaded=function(e){this.model=e;this.model.bind(this.event_name,this.__kb._onValueChange);return this._onValueChange()};e.prototype._onModelUnloaded=function(){if(this.__kb.localizer&&this.__kb.localizer.destroy){this.__kb.localizer.destroy();this.__kb.localizer=null}this.model.unbind(this.event_name,this.__kb._onValueChange);return this.model=null};e.prototype._onValueChange=function(){var e;e=this.__kb.value_observable();return e!==this.model?this.__kb.value_observable(this.model):this.__kb.value_observable.valueHasMutated()};return e}();Knockback.triggeredObservable=function(e,t){return new Knockback.TriggeredObservable(e,t)};var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);r.prototype=t.prototype;e.prototype=new r;e.__super__=t.prototype;return e};Knockback.AttributeConnector=function(){function e(e,t,n){var r;this.key=t;this.options=n!=null?n:{};kb.utils.wrappedModel(this,e);this.options=_.clone(this.options);this.__kb.value_observable=ko.observable();r=kb.utils.wrappedObservable(this,ko.dependentObservable({read:_.bind(this.read,this),write:_.bind(this.write,this)}));r.destroy=_.bind(this.destroy,this);r.model=_.bind(this.model,this);r.update=_.bind(this.update,this);this.__kb.initializing=!0;this.update();this.__kb.initializing=!1;return r}e.name="AttributeConnector";e.prototype.destroy=function(){this.__kb.value_observable=null;kb.utils.wrappedObservable(this).dispose();return kb.utils.wrappedObservable(this,null)};e.prototype.read=function(){return this.__kb.value_observable()};e.prototype.write=function(e){var t,n;t=kb.utils.wrappedModel(this);if(!t)return;if(!this.options.read_only){n={};n[this.key]=e;return t.set(n)}if(!this.__kb.initializing)throw"Cannot write a value to a dependentObservable unless you specify a 'write' option. If you wish to read the current value, don't pass any parameters."};e.prototype.model=function(e){var t;t=kb.utils.wrappedModel(this);if(arguments.length===0)return t;if(t===e)return;kb.utils.wrappedModel(this,e);return this.update()};e.inferType=function(e,t){var n,r;r=e.get(t);if(!r){if(!(Backbone.RelationalModel&&e instanceof Backbone.RelationalModel))return"simple";n=_.find(e.getRelations(),function(e){return e.key===t});return n?n.collectionKey?"collection":"model":"simple"}return r instanceof Backbone.Collection?"collection":r instanceof Backbone.Model||Backbone.ModelRef&&r instanceof Backbone.ModelRef?"model":"simple"};e.createByType=function(e,t,n,r){var i;switch(e){case"collection":i=r?_.clone(r):{};r.view_model||r.view_model_create||r.children||r.create||(i.view_model=kb.ViewModel);r.store&&r.store.addResolverToOptions(i,t.get(n));return kb.collectionAttributeConnector(t,n,i);case"model":i=r?_.clone(r):{};i.options||(i.options={});r.view_model||r.view_model_create||r.children||r.create||(i.view_model=kb.ViewModel);r.store&&r.store.addResolverToOptions(i.options,t.get(n));return kb.viewModelAttributeConnector(t,n,i);default:return kb.simpleAttributeConnector(t,n,r)}};e.createOrUpdate=function(e,t,n,r){var i,s;if(e){kb.utils.observableInstanceOf(e,kb.AttributeConnector)&&(e.model()!==t?e.model(t):e.update());return e}if(!t)return kb.simpleAttributeConnector(t,n,r);if(r.hasOwnProperty("create")){if(!r.create)throw new Error("Knockback.AttributeConnector: options.create is empty"
);return r.create(t,n,r.options||{})}s=t.get(n);if(r.hasOwnProperty("view_model")){if(!r.view_model)throw new Error("Knockback.AttributeConnector: options.view_model is empty");return new r.view_model(s,r.options||{})}if(r.hasOwnProperty("view_model_create")){if(!r.view_model_create)throw new Error("Knockback.AttributeConnector: options.view_model_create is empty");return r.view_model_create(s,r.options||{})}if(r.hasOwnProperty("children")){if(!r.children)throw new Error("Knockback.AttributeConnector: options.children is empty");typeof r.children=="function"?i={view_model:r.children}:i=r.children||{};return kb.collectionAttributeConnector(t,n,i)}return this.createByType(this.inferType(t,n),t,n,r)};return e}();Knockback.SimpleAttributeConnector=function(e){function t(){t.__super__.constructor.apply(this,arguments);return kb.utils.wrappedObservable(this)}__extends(t,e);t.name="SimpleAttributeConnector";t.prototype.destroy=function(){this.current_value=null;return t.__super__.destroy.apply(this,arguments)};t.prototype.update=function(){var e,t,n;t=kb.utils.wrappedModel(this);if(!t)return;n=t.get(this.key);e=this.__kb.value_observable();if(!_.isEqual(e,n))return this.__kb.value_observable(n)};t.prototype.write=function(e){var n;n=kb.utils.wrappedModel(this);if(!n){this.__kb.value_observable(e);return}return t.__super__.write.apply(this,arguments)};return t}(Knockback.AttributeConnector);Knockback.simpleAttributeConnector=function(e,t,n){return new Knockback.SimpleAttributeConnector(e,t,n)};Knockback.CollectionAttributeConnector=function(e){function t(){t.__super__.constructor.apply(this,arguments);return kb.utils.wrappedObservable(this)}__extends(t,e);t.name="CollectionAttributeConnector";t.prototype.destroy=function(){var e;e=this.__kb.value_observable();e&&typeof e.refCount=="function"&&e.refCount()>0&&e.release();return t.__super__.destroy.apply(this,arguments)};t.prototype.update=function(){var e,t,n,r=this;t=kb.utils.wrappedModel(this);if(!t)return;n=t.get(this.key);e=this.__kb.value_observable();if(!e)return this.options.store?this.__kb.value_observable(this.options.store.resolveValue(n,function(){return kb.collectionObservable(n,r.options)})):this.__kb.value_observable(kb.collectionObservable(n,this.options));if(e.collection()!==n){e.collection(n);return this.__kb.value_observable.valueHasMutated()}};t.prototype.read=function(){var e;e=this.__kb.value_observable();if(e)return e();return};return t}(Knockback.AttributeConnector);Knockback.collectionAttributeConnector=function(e,t,n){return new Knockback.CollectionAttributeConnector(e,t,n)};Knockback.ViewModelAttributeConnector=function(e){function t(){t.__super__.constructor.apply(this,arguments);return kb.utils.wrappedObservable(this)}__extends(t,e);t.name="ViewModelAttributeConnector";t.prototype.destroy=function(){var e;e=this.__kb.value_observable();e&&typeof e.refCount=="function"&&e.refCount()>0&&e.release();return t.__super__.destroy.apply(this,arguments)};t.prototype.update=function(){var e,t,n,r,i=this;t=kb.utils.wrappedModel(this);if(!t)return;n=t.get(this.key);e=this.__kb.value_observable();if(!e){r=this.options.options?_.clone(this.options.options):{};return r.store?this.__kb.value_observable(r.store.resolveValue(n,function(){return i.options.view_model?new i.options.view_model(n,r):i.options.view_model_create(n,r)})):this.__kb.value_observable(this.options.view_model?new this.options.view_model(n,r):this.options.view_model_create(n,r))}if(!e.model||typeof e.model!="function")throw new Error("Knockback.viewModelAttributeConnector: unknown how to model a view model");if(e.model()!==n){e.model(n);return this.__kb.value_observable.valueHasMutated()}};return t}(Knockback.AttributeConnector);Knockback.viewModelAttributeConnector=function(e,t,n){return new Knockback.ViewModelAttributeConnector(e,t,n)};var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);r.prototype=t.prototype;e.prototype=new r;e.__super__=t.prototype;return e};Knockback.ViewModel_RCBase=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}__extends(t,e);t.name="ViewModel_RCBase";t.prototype.__destroy=function(){var e,t,n;n=[];for(e in this){t=this[e];if(!t||e==="__kb")continue;kb.utils.release(t)?n.push(this[e]=null):n.push(void 0)}return n};return t}(Knockback.RefCountable);Knockback.ViewModel=function(e){function t(e,n){var r,i,s,o;n==null&&(n={});t.__super__.constructor.apply(this,arguments);Knockback.stats_on&&kb.stats.view_models++;n.store_skip_resolve||kb.Store.resolveFromOptions(n,this);if(n.store)this.__kb.store=n.store;else{this.__kb.store=new kb.Store;this.__kb.store_is_owned=!0}this.__kb._onModelChange=_.bind(this._onModelChange,this);this.__kb._onModelLoaded=_.bind(this._onModelLoaded,this);this.__kb._onModelUnloaded=_.bind(this._onModelUnloaded,this);this.__kb.internals=n.internals;this.__kb.requires=n.requires;this.__kb.children=n.children;this.__kb.create=n.create;this.__kb.read_only=n.read_only;kb.utils.wrappedModel(this,e);if(Backbone.ModelRef&&e instanceof Backbone.ModelRef){this.__kb.model_ref=e;this.__kb.model_ref.retain();kb.utils.wrappedModel(this,this.__kb.model_ref.getModel());this.__kb.model_ref.bind("loaded",this.__kb._onModelLoaded);this.__kb.model_ref.bind("unloaded",this.__kb._onModelUnloaded)}this.__kb.model&&this._onModelLoaded(this.__kb.model);if(!this.__kb.internals&&!this.__kb.requires)return this;i=_.union(this.__kb.internals?this.__kb.internals:[],this.__kb.requires?this.__kb.requires:[]);if(!this.__kb.model_ref||this.__kb.model_ref.isLoaded())i=_.difference(i,_.keys(this.__kb.model.attributes));for(s=0,o=i.length;s<o;s++){r=i[s];this._updateAttributeConnector(this.__kb.model,r)}}__extends(t,e);t.name="ViewModel";t.prototype.__destroy=function(){var e;e=this.__kb.model;kb.utils.wrappedModel(this,null);this._modelUnbind(e);this.__kb.store_is_owned&&this.__kb.store.destroy();this.__kb.store=null;t.__super__.__destroy.apply(this,arguments);if(Knockback.stats_on)return kb.stats.view_models--};t.prototype.model=function(e){var t;t=kb.utils.wrappedModel(this);if(arguments.length===0)return t;if(e===t)return;t&&this._onModelUnloaded(t);if(e)return this._onModelLoaded(e)};t.prototype._modelBind=function(e){if(!e)return;e.bind("change",this.__kb._onModelChange);if(Backbone.RelationalModel&&e instanceof Backbone.RelationalModel){e.bind("add",this.__kb._onModelChange);e.bind("remove",this.__kb._onModelChange);return e.bind("update",this.__kb._onModelChange)}};t.prototype._modelUnbind=function(e){if(!e)return;e.unbind("change",this.__kb._onModelChange);if(Backbone.RelationalModel&&e instanceof Backbone.RelationalModel){e.unbind("add",this.__kb._onModelChange);e.unbind("remove",this.__kb._onModelChange);return e.unbind("update",this.__kb._onModelChange)}};t.prototype._onModelLoaded=function(e){var t,n;kb.utils.wrappedModel(this,e);this._modelBind(e);n=[];for(t in this.__kb.model.attributes)n.push(this._updateAttributeConnector(this.__kb.model,t));return n};t.prototype._onModelUnloaded=function(e){var t,n;this._modelUnbind(e);kb.utils.wrappedModel(this,null);n=[];for(t in e.attributes)n.push(this._updateAttributeConnector(null,t));return n};t.prototype._onModelChange=function(){var e,t,n;if(this.__kb.model._changed){t=[];for(e in this.__kb.model.attributes)t.push(this.__kb.model.hasChanged(e)?this._updateAttributeConnector(this.__kb.model,e):void 0);return t}if(this.__kb.model.changed){n=[];for(e in this.__kb.model.changed)n.push(this._updateAttributeConnector(this.__kb.model,e));return n}};t.prototype._updateAttributeConnector=function(e,t){var n;n=this.__kb.internals&&_.contains(this.__kb.internals,t)?"_"+t:t;return this[n]=kb.AttributeConnector.createOrUpdate(this[n],e,t,this._createOptions(t))};t.prototype._createOptions=function(e){var t;if(this.__kb.children){if(this.__kb.children.hasOwnProperty(e)){t=this.__kb.children[e];typeof t=="function"&&(t={view_model:t});t.options={read_only:this.__kb.read_only,store:this.__kb.store};return t}if(this.__kb.children.hasOwnProperty("create"))return{create:this.__kb.children.create,options:{read_only:this.__kb.read_only,store:this.__kb.store}}}else if(this.__kb.create)return{create:this.__kb.create,options:{read_only:this.__kb.read_only,store:this.__kb.store}};return{read_only:this.__kb.read_only,store:this.__kb.store}};return t}(Knockback.ViewModel_RCBase);Knockback.viewModel=function(e,t){return new Knockback.ViewModel(e,t)};